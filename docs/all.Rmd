---
title: "IBD Meta-analysis"
always_allow_html: yes
author: 
- Taylor Reiter
- Luiz Irber
- ...
- Phillip Brooks
- Alicia Gingrich
- C. Titus Brown
date: "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: bibliography.bib
graphics: yes
figsintext: yes
geometry: "left=1in,right=1in,top=1in,bottom=1in"
header-includes:
- \usepackage{booktabs}
- \usepackage{verbatim}
- \newcommand{\comm}[1]{}
- \usepackage{float} \floatplacement{figure}{H}
- \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{S\arabic{table}}
  \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}
- \usepackage[font={small,it}, labelfont={bf}]{caption}
- \usepackage{setspace}
- \singlespacing
- \usepackage{lineno}
- \linenumbers
keep_tex: yes
output:
  bookdown::pdf_document2:
    toc: false
---

```{r setup, include=FALSE, eval = T}
knitr::opts_chunk$set(echo = F, eval = T, message = F, warning = F, cache = F, 
                      include = T, fig.keep = 'high', fig.path = "Rmd_fig_out/",
                      dpi=400)
```

```{r libs}
library(kableExtra)
```

# Introduction

Inflammatory bowel disease (IBD) is a spectrum of diseases characterized by chronic inflammation of the intestines that is likely caused by host-mediated inflammatory responses at least in part elicited by microorganisms [@kostic2014].
IBD is cyclical, with periods of active disease and remission. 
IBD manifests in three subtypes depending on clinical presentation, including Crohn's disease (CD), which presents as discontinuous patches of inflammation throughout the gastrointestinal tract, ulcerative colitis (UC), which presents as continuous inflammation isolated to the colon, and undetermined, which cannot be distinguished as CD or UC.
Diagnosis is often clinically difficult, with ramifications associated with over- or under-treatment that lead to decreased patient well-being. 
Detection of microbial signatures associated with IBD subtype may lead to improved diagnostic criteria and therapeutics that extend periods of remission.

The microbiome of CD and UC is heterogeneous, and studies that characterize the microbiome often produce conflicting results.
This is likely in part driven by large inter- and intra-individual variation [@lloyd2019], but is also attributable to non-standardized laboratory, sequencing, and analysis techniques used to profile the gut microbiome [@kumar2019integrating]. 
Dysbiosis is frequently observed in IBD, particularly in CD [@kang2010dysbiosis; @machiels2014decrease; @lewis2015; @moustafa2018; @qin2010], however dysbiosis alone is not a signature of IBD [@lloyd2019].
Dysbiosis is defined as a decrease in gut microbial diversity that results in an imbalance between protective and harmful microorganisms, leading to intestinal inflammation [@weiss2017mechanisms].

Strain-level differences may account for some heterogeneity in IBD gut microbiome profiles. 
A recent investigation of time-series gut microbiome metagenomes found that one clade of *Ruminococcus gnavus* is enriched in CD [@hall2017]. 
Further, this clade produces an inflammatory polysaccharide [@henke2019ruminococcus].
The enrichment of this strain in CD was masked by concomitant decreases in other *Ruminococcus* species in IBD, highlighting the need for strain-resolved analysis of metagenomic sequencing in the exploration of IBD gut microbiomes.
Here we use *strain* to refer to within-species variation that generates grouping below the species level.

Strain-resolved analysis of metagenomics is challenging. 
Shotgun metagenomics captures the functional potential of microbial communities through DNA sequencing of genes and organisms. 
Multiple analysis techniques have been proposed for shotgun metagenomics, however the majority of studies investigating the gut microbiome in IBD have used reference-based analysis [@gevers2014; @lewis2015; @hall2017; @franzosa2019; @lloyd2019]. 
Reference-based techniques are high-resolution and often rich in tertiary information like functional annotations, niche associations, and metabolic products. 
However, it is difficult to resolve strains with reference-based techniques alone given that databases are often incomplete, and that assigning reads to the best reference is computationally intensive and thus needs to be performed on an incomplete set of reference organisms and genes. 
These challenges may obscure either the presence or enrichment of a specific strain, masking strain dynamics in disease  [@thomas2019multiple; @breitwieser2019review].
<!-- In particular, if strain variation primarily occurs outside of highly-conserved clade-specific markers, it will be undetectable. -->

Alternative analysis techniques are better suited for strain-resolved analysis at scale.
K-mers, words of length *k* in nucleotide sequences, have previously been used for annotation-free characterization of sequencing data [@sheppard2013genome; @dubinkina2016assessment; @standage2019kevlar].
K-mers are suitable for strain-resolved metagenome analysis because they do not need to be present in reference databases to be included in analysis, they do not rely on marker genes which we expect to be largely conserved at the strain level, and they are suitable for species- and strain-level classification [@koslicki2016]. 
However, investigating all k-mers in a cohort of metagenomes is more computationally intensive than reference-based approaches [@benoit2016multiple]. 
Data-reduction techniques like MinHash make k-mer-based analysis scalable to large-scale sequence comparisons, including comparisons between many metagenomes, and comparisons against all ~500,000 sequenced microorganisms [@pierce2019; @rowe2019levee]. 
MinHash sacrifices the fine-scaled resolution of reference-based techniques but is representative of the full sequencing sample, including strains that are associated with diseases. 

Tertiary information acquired through reference-based analysis, in particular functional annotations and gene-gene proximity, is lost through MinHash analysis but can be recovered via assembly-graph queries with k-mers of interest [@brown2020exploring; @jaillard2018fast]. 
Both k-mers and assembly graphs represent all seqeunces contained within a metagenome, retaining strain-specific features that may be lost by other analysis approaches. 
Assembly graphs reassociate k-mers with important context (e.g. operon structures) and known annotations, recovering critical information lost through the MinHash approach.
We refer to sequences nearby to and recovered by queries as assembly graph *neighborhoods* [@brown2020exploring]. 
Neighborhoods are targeted subsets of metagenomes that contain only sequences of interest that can be analyzed with traditional, computationally-intensive, high-resolution methods. 
While these methods may sometimes fail given sequence complexity or lack of representation in databases, it is clear when the fail, making these known-unknown problems instead of unknown-unknown problems.

Here we capitalize on k-mer- and assembly-graph-based techniques to perform a meta-analysis of six studies of IBD gut metagenome cohorts comprising 260 CD, 132 UC and 213 healthy controls (see **Table \ref{tab:cohorts}**) [@lloyd2019; @lewis2015; @hall2017; @franzosa2019; @gevers2014; @qin2010].
Through meta-analysis, we demonstrate a consistent signature of IBD subtype in fecal microbiome metagenomes. 
Only a small subset of all k-mers are predictive of UC and CD, and these k-mers originate from a core set of microbial genomes. 
We find that stochastic loss of diversity in this core set of microbial genomes is a hallmark of CD, and to a lesser extent, UC. 
While reduced diversity is responsible for the majority of disease signatures, multiple strains are enriched in disease. 
These strains occur more frequently in IBD metagenomes, but are present in low abundance in nonIBD as well.
Our findings highlight the need for strain-level analysis of metagenomic data sets, and provide future avenues for research into IBD therapeutics.

# Results

## K-mers capture variation due to IBD subtype

```{r cohorts, echo=FALSE, message=FALSE, warnings=FALSE}
cohort_data <- "
Cohort      |   Name          | Country      |Total|CD|UC|nonIBD | Reference
iHMP        | IBDMDB                   | USA              | 106   | 50  | 30  | 26    | [@lloyd2019] 
PRJEB2054   | MetaHIT                  | Denmark, Spain   | 124   | 4   | 21  | 99    | [@qin2010] 
SRP057027   | NA                       | Canada, USA      | 112   | 87  | 0   | 25    | [@lewis2015]
PRJNA385949 | PRISM, STiNKi            | USA              | 17    | 9   | 5   | 3     | [@hall2017]
PRJNA400072 | PRISM, LLDeep, and NLIBD | USA, Netherlands | 218   | 87  | 76  | 55    |[@franzosa2019]
PRJNA237362 | RISK                     | North America    | 28    | 23  | 0   | 5     | [@gevers2014]
Total       |                          |                  | 605   | 260 | 132 | 213  |    "      
df <- read.delim(textConnection(cohort_data), header=T,sep="|", strip.white=TRUE, stringsAsFactors=FALSE)
row.names(df)<-NULL
kable(df, caption = "Six IBD cohorts used in this meta-analysis.", format = "latex",
      booktabs = T) %>%
  kable_styling(font_size = 9, latex_options ="striped")
```

```{r overview, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.cap="Overview of the metagenome analysis technique used in this paper. **A** K-mers are words of length *k* in DNA. The sequence is decomposed into k-mers of *k = 4*. **B** Short read metagenomes consist of 36-300 bp reads derived from sequencing DNA from environmental samples. We decompose reads into k-mers and subsample these k-mers, selecting k-mers that evenly represent the sequence diversity within a sample. We then identify interesting k-mers using random forests, and associate these k-mers with genomes in reference databases. Meanwhile, we construct a compact de Bruijn assembly graph that contains all k-mers from a metagenome. We query this graph with known genes or genomes associated with interesting k-mers to recover sequence diversity nearby in the assembly graph. In the colored assembly graph, light grey nodes indicate nodes that contain at least one identical k-mer to the query, while nodes outlined in orange indicate the nearby sequences recovered via assembly graph queries. The combination of all orange nodes produces a sample-specific pangenome that represents the strain variation of closely-related organisms within a single metagenome. We repeat this process for all metagenomes and generate a single metapangenome depicted in orange, blue, and pink."}
knitr::include_graphics('figures/fig1.pdf')
```

We developped a reference-free pipeline to fully characterize gut metagenomes of IBD patients (**Figure \ref{fig:overview}**).
After consistent preprocessing, we use scaled MinHash sketching to produce subsampled k-mer abundance profiles of metagenomes that reflect the sequence diversity in a sample [@pierce2019], and use these profiles to perform metagenome-wide k-mer association with IBD subtype. 
We refer to scaled MinHash sketches as signatures, and for simplicity, continue referring to the sub-sampled k-mers in a signature as k-mers. 
In total, we profiled 7,376,151 k-mers across all samples in all cohorts. 

Variation due to IBD diagnosis is detectable in k-mer profiles of gut metagenomes from different cohorts.
We calculated pairwise distance matrices using jaccard distance and cosine distance between k-mer profiles, where jaccard distance captured sample richness and cosine distance captured sample diversity. 
We performed principle coordinate analysis and PERMANOVA with these distance matrices (**Figure \ref{fig:compplts}**), using the variables study accession, diagnosis, library size, and number of k-mers observed in a sample (**Table \ref{tab:permanova}**). 
Number of k-mers observed in a sample accounts for the highest variation, possibly reflecting reduced diversity in stool metagenomes of CD and UC patients (reviewed in [@schirmer2019microbial]). 
Study accounts for the second highest variation, emphasizing that technical artifacts can introduce strong signals that may influence heterogeneity in IBD microbiome studies but that can be mitigated through meta-anlysis [@wirbel2019].
Diagnosis accounts for a similar amount of variation as study, indicating that there is a small but detectable signal of IBD subtype in stool metagenomes.

```{r compplts, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.cap="Principle coordinate analysis of metagenomes from IBD cohorts performed on k-mer profiles. **A** Jaccard distance. **B** Angular distance."}
knitr::include_graphics('figures/fig2.pdf')
```

```{r permanova, echo=FALSE, message=FALSE, warnings=FALSE}
permanova_data <- "
Variable |Jaccard distance | Angular distance
Number of k-mers | 9.9%           | 6.2%
Study accession  | 6.6%           | 13.5
Diagnosis        | 6.2%           | 3.3%
Library size     | 0.009%        | 0.01%"      
df <- read.delim(textConnection(permanova_data), header=T,sep="|", strip.white=TRUE, stringsAsFactors=FALSE)
row.names(df)<-NULL
kable(df, format = "latex", booktabs = T, 
      caption = "Results from PERMANOVA performed on Jaccard and Angular distance matrices. Number of k-mers refers to the number of k-mers in a signature, while library size refers to the number of raw reads per sample. All test were significant at p < .001.") %>%
  kable_styling(font_size = 9, latex_options ="striped")
```

## K-mers are weakly predictive of IBD subtype

To evaluate whether the variation captured by diagnosis is predictive of IBD subtype, we built random forests classifiers to predict CD, UC, or nonIBD subtype.
Random forests is a supervised learning classification model that estimates how predictive k-mers are of IBD subtype, and weights individual k-mers as more or less predictive using a metric called variable importance.
To assess whether disease signatures generalize across study populations, we used a leave-one-study-out cross-validation approach where we built and optimized a classifier using five cohorts and validated on the sixth.
Given the high-dimensional structure of this data set (e.g. many more k-mers than samples), we first used variable selection to narrow the set of predictive k-mers in the training set [@janitza2018; @degenhardt2017].
Variable selection reduced the number of k-mers used in each model by two orders of magnitude, from 7,376,151 to 29,264-41,701 (**Table \ref{tab:varselhashes}**). 
Using this reduced set of k-mers, we then optimized each random forests classifier on the training set, producing six optimized models. 
We validated each model on the left-out study.
The accuracy on the validation studies ranged from 49.1%-75.9% (**Table \ref{tab:acc}**, **Figure \ref{fig:confusionplts}**), outperforming a previously published model built on metagenomic data alone [@franzosa2019].

```{r acc, echo=FALSE, message=FALSE, warnings=FALSE}
acc_data <- "
Validation Study | k-mer model |full marker gene model | core marker gene model | k-mer model of core marker genes 
SRP057027        |    75.9    | 85.7 |   86.4       |   71.7  
PRJNA237362      |    71.4    | 75 |      75        |   64.3  
PRJEB2054        |    69.4    | 39 |     19.1       |   15.5   
PRJNA385949      |    52.9    | 47.1 |     52.9     |   41.2
PRJNA400072      |    50.9    | 49.5 |     48.1     | 47.4
iHMP             |    49.1    | 48.6|   44.2       |   46.5"
df <- read.delim(textConnection(acc_data), header=T,sep="|", strip.white=TRUE, stringsAsFactors=FALSE)
row.names(df)<-NULL
kable(df, format = "latex", booktabs = T, 
      caption = "Accuracy of random forest classifiers built with different underlying representations of IBD metagenomes when applied to each validation set.", 
      col.names = c("validation study", "k-mer model", "full marker gene model", "core marker gene model", "k-mer model of core marker genes")) %>%
  kable_styling(font_size = 9, latex_options ="striped")
```

We found that a substantial fraction of k-mers are shared between models, indicating there is a consistent biological signal captured among classifiers.
Nine hundred and thirty-two k-mers were shared between all classifiers, while 3,859 k-mers were shared between at least five classifiers (**Figure \ref{fig:upset}**).
The presence of shared k-mers between classifiers indicates that there is a weak but consistent biological signal for IBD subtype between cohorts.      
                
Shared k-mers represent 2.8% of all k-mers used to build the optimized classifiers, but account for an outsized proportion of variable importance in the optimized classifiers.
After normalizing variable importance across classifiers, 40.2% of the total variable importance was held by shared k-mers, with 21.5% attributable to the 932 k-mers shared between all six classifiers. 
This indicates that shared k-mers contribute a large fraction of predictive power for classification of IBD subtype. 

Many k-mers were identifiable when compared against all microbial genomes in GenBank, as well as metagenome-assembled genomes from three recent *de novo* assembly efforts from human microbiome metagenomes [@pasolli2019; @nayfach2019; @almeida2019]. 
77.7% of k-mers from all classifiers were identifiable and anchored to 1,161 genomes (**Figure \ref{fig:sharedfeatures} A**). 
In contrast, 69.4% of shared k-mers anchored to only 41 genomes (**Figure \ref{fig:sharedfeatures} B**).
These shared 41 genomes held an additional 10.3% of variable importance over the shared k-mers because some genomes contain additional k-mers not shared across all models.
Using GTDB taxonomy, we find 38 species represented among the 41 genomes (**Figure \ref{fig:sharedfeatures} C**).
These genomes represent a microbial core important for IBD subtype classification. 

```{r sharedfeatures, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.cap="**A** K-mers in random forest classifiers anchor to 1,161 known genomes accounting for 75.1-80.3% of all predictive k-mers in each model. Models are labelled by validation study. **B** The 3,859 k-mers that are shared between the majority of models anchor to 41 genomes. These genomes account for 50.5% of cumulative normalized variable importance for k-mers across all models."}
knitr::include_graphics('figures/fig3.pdf')
```

## Decreased abundance of marker genes dominates singatures of IBD

To determine the functional annotation of the shared k-mers, we performed assembly graph queries using all genes from the 41 shared genomes, and anchored k-mers to the genes when they occured in gene neighborhoods.

<!-- To annotate each k-mer, we reasoned that a k-mer with predictive importance would be nearby the genomic feature driving the predictive signal in both genomic DNA and the DNA assembly graph.  -->
<!-- Therefore, we performed assembly graph queries on each metagenome using each gene in the 41 shared genomes.  -->
<!-- We then identified all gene query neighborhoods in which each k-mer occurred, and transferred those annotations to the k-mer. -->

Many k-mers annotate as bacterial marker genes, as well as 16S and 23S ribosomal RNA (**Figure \ref{fig:hashcontent}**). 
Marker genes are present in most known bacteria and distinguish taxonimic ranks through sequence similarity estimates [@parks2015checkm; @na2018ubcg].
Four hundred and forty k-mers accounting for 7.5% of variable importance across all models annotated as bacterial marker genes. 
We performed differential abundance analysis on these k-mers and found that 89.4% are decreased in IBD, particularly in CD. 
This demonstrates that loss of species diversity captured by decreased marker gene abundance is a signature of IBD subtype.

We next investigated whether accuracy in out k-mer models is driven by signals of reduced diversity in IBD alone. 
We built a series of classifiers to determine whether the k-mer models contained additional predictive accuracy derived from genetic elements other than marker genes. 

First, we built random forest classifiers using abundance of marker genes alone from the whole metagenome and from the shared 41 genomes. 
Both model types performed similarly to the k-mer models (**Table \ref{tab:acc}**), but performed marginally better at CD classification and marginally worse at UC classification (**Figure \ref{fig:confusionplts}**). 
Reduced accuracy on cohort PRJEB2054 is attributable to 36 base pair reads used for sequencing that reduces accuracy of marker gene prediction from reads.

Next, we built k-mer models using subsampled k-mers from the marker genes and their abundances to better represent the marker gene sequences as they appeared in the original k-mer models. 
These models performed worse than the orginal k-mer models and the marker gene models (**Table \ref{tab:acc}**). 
The accuracy of the k-mer model of marker genes is a proxy for the fraction of accuracy in the original k-mer models attributable to marker genes, or the decreased species diveristy observed in IBD. 
The remeaining fraction of accuracy is not driven by decreased species abundance, but by other differences in IBD subtypes. 

<!-- Both the k-mer model and the marker gene model ranked a 16S rRNA sequence from the genus *Acetatifactor* as having the highest variable importance across studies, demonstrating that while based on different data features, both model types extract similar information.   -->


```{r hashcontent, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.cap="Decrease in marker gene abundance drives differences between CD and nonIBD. **A** Many shared k-mers annotate as marker genes or ribosomal RNAs. 11.4% of the 3859 shared k-mers annotate as marker genes, accounting for 7.5% of variable importance across all models. **B** The majority of k-mers are less abundant in IBD than in nonIBD. However, k-mers that anchor to four genomes in CD and two genomes in UC are more abundant. The 41 shared genomes are annoated as 38 species in the GTDB taxonomy.**C** Using pangenome assemblies from these genomes, many KEGG pathways are enriched among genes that are more abundant in CD than nonIBD. Biosynthesis is abbreviated as biosynth. **D** Number of predicted genes in the pangenome that are differentially abundant between CD or UC and nonIBD for each of the enriched strains."}
knitr::include_graphics('figures/fig4.pdf')
```

## Decreased diversity punctuated by strain enrichment explains IBD

To understand microbial signatures of IBD captured by the k-mer model, we performed differential abundance analysis on the remaining shared k-mers that did not annotate as marker genes.
While many more k-mers are differentially abundant in CD than UC when compared to nonIBD (1815 k-mers versus 166 k-mers, respectively), the majority of k-mers are less abundant in IBD (**Figure \ref{fig:hashcontent}**).
This is driven by loss of species diversity, not systematic loss of specific functional potential.

Many beneficial bacteria, in particular those that are oxygen sensitive, decrease in abundance in IBD.
Two strains of *Faecalibacterium prausnitzii* have the largest number of k-mers with decreased abundance compared to nonIBD (**Figure \ref{fig:hashcontent} B**). 
*F. prausnitzii* is an obligate anaerobe and a key butyrate producer in the gut, and plays a crucial role in reducing intestinal inflammation [@lopez2017faecalibacterium].
*F. prausnitzii* is extremely sensitive to oxygen, though may be able to withstand oxygen exposure for up to 24 hours depending on the availability of metabolites for extracellular electron transfer [@lopez2017faecalibacterium].
*Acetatifactor* (GTDB species *Acetatifactor sp900066365*) has k-mers with the largest variable importance with decreased abundance compared to nonIBD (**Figure \ref{fig:hashcontent}**).
*Acetatifactor* is a bile-acid producing bacteria associated with a healthy gut, but limited evidence has associated it with decreased abundance in IBD [@pathak2018intestine].
In UC, *Gemmiger formicilis* has both the largest variable importance and number of k-mers with decreased abundance compared to nonIBD (**Figure \ref{fig:hashcontent}**).
*G. formicilis* is a strictly anaerobic bacteria that produces both formic acid and butyric acid [@gossling1975gemmiger].
We also see a decrease in other oxygen-sensitive sepecies, including *Lachnospira eligens* (annotated in NCBI taxonomy as *[Eubacterium] elegans*). *L. elegans* is an obligate anaerobe that is unable to tolerate atmospheric oxygen for an hour [@hall2017]. 
Collectively, the decrease in species diversity we observe in IBD, in particular CD, is consistent with a shift toward increased oxidative stress during disease [@rigottier2013dysbiosis].

A substantial portion of k-mers from four genomes in CD and two genomes in UC are more abundant in disease (**Figure \ref{fig:hashcontent}**).
While many of the k-mers in the less abundant fractions from these genomes annotate to marker genes, the more abundant k-mers annotate to metabolic pathways like starch and sucrose metabolism or flagellar assembly (**Figure \ref{fig:hashcontentsupp}**).
<!-- TR: move to supplement once the other figure is made -->
This is indicative of strain enrichment in IBD, where most strains from a species become less abundant but a strain with distinct accessory genes becomes more abundant.
Enrichment of these metabolic pathways is consistent with functional specialization of strains in different environmental niches [@costea2017subspecies].
These four genomes belong to *Faecalicatena gnavus* (referred to as *[Ruminococcus] gnavus* in NCBI taxonomy and IBD literature) and  *Clostridium bolteae* in CD, and two genomes in the genus *Flavonifractor* in CD and UC. 

*F. gnavus* is an aerotolerant anaerobe, one clade of which was recently found to be enriched in CD [@hall2017], and to produce an inflammatory polysaccharide [@henke2019ruminococcus]. 
*C. bolteae* i sa member of the normal gut microbiota but is an opportunistic pathogen that exploits compromised intestinal barriers [@dehoux2016comparative].
It is associated with disturbance succession when the stable gut consortia is compromised [@lozupone2012identifying], and has increased gene expression during gut dysbiosis [@lloyd2019].
<!-- *Flavonifractor plautii* and *Flavonifractor sp000508885*  -->
Species from the genus *Flavonifractor* have rarely been associated with CD or UC [@schaffler2016mucosa; @kwak2020development; @selvig2020fecal; @chen2019p854].
Interestingly, *Flavonifractor sp000508885* (originally publised as *Flavonifractor plautii*) was identified as a member of a 17-species consortia that induces human CD4+FOXP3+Treg cells, key immunomodulators of gut homeostasis [@atarashi2013t].
However, *F. sp000508885* was one of two strains in the consortia detected as more abundant in UC metagenomes [@atarashi2013t], and genes encoding virulence factors such as flagellar assembly were detected in thi strain [@atarashi2013t]. 
This suggests that *F. sp000508885* may be associated with disease only at high abundance.

To fully characterize the fraction of the pangenomes of these four strains that are more abundant in IBD, we generated pangenomes via assembly, clustering, and annotation of all genes in the assembly graph neighborhood of each strain.
Not all shared k-mers from these four strains are contained in the pangenome because many do not assemble (**Figure \ref{fig:assembled}**).
<!-- Across the four strains, an average of 74.1% of k-mers that are less abundant in IBD do not assemble, while 9.6% of k-mers that are more abundant in IBD do not assemble. -->
Across the four strains, an average of 74.1% and 9.6% of k-mers that are less or more abundant in IBD do not assemble, respectively.
Many of the unassembled k-mers that are less abundant in IBD annotate to 16S and 23S ribosomal RNA, which frequently do not assemble due to sequence complexity (CITE).
While these sequences are not detected by assembly-based approaches, our k-mer-based analysis rescues these associations.
Of shared k-mers that do assemble from these four strains, 98.9% anchor to genes with the same differential abundance direction as the k-mers (e.g., more or less abundant). 
However, many genes that anchor k-mers, particularly those that are more abundant in *Flavonifractor*, are not significantly different in CD or UC compared to nonIBD after bonferroni p-value correction. 
Even still, we detect many significantly differentially abundant genes among these strains (**Figure \ref{fig:hashcontent}**).
These results indicate that subsampled k-mer profiles are an adequate, scalable tool to use to investigate strain-level variation, and are powerful enough to capture large-scale disease associations.

We next performed pathway enrichment analysis on the KEGG orthologs in these four strains that were only annotated as more abundant in IBD. 
Given the small number of differentially abundant genes in UC, the only significantly enriched pathwyas contained one gene. 
In contrast, many pathways are enriced in CD (**Figure \ref{fig:hashcontent}**).

Many enriched pathways are associated with virulence factors, including quorum sensing, flagellar assembly, and vancomycin resistance. 
Quorum sensing controls many pathways associated with virulence and pathogenicity (e.g. biofilm formation [@parsek2005sociomicrobiology]), but also coordinates many other functions of the human gut microbiota, disruption of which may lead to disturbance of gut homeostasis [@thompson2016chemical; @krzyzek2019challenges]. 
Of all induced pathways, only quorum sensing is enriched among all four genomes that are more abundant in CD and UC, suggesting that it may be an entry point for potential therapeutics.

Flagellar assembly is enriched in three of four strains, with 24 KEGG orthologs detected in *C. bolteae* and three orthologs detected in each of the *Flavonifractor* strains. 
Flagella are rotating structures that enable bacterial motility and promote virulence by allowing bacteria to move toward host tissue and participating in biofilm formation, adherence, and invasion [@haiko2013role]. 
The dominant protein in flagella is flagellin, and monomeric flagellin can activate host pro-inflammatory gene expression via toll-like receptor 5 [@hayashi2001innate]. 
While increased flagellin is a feature of inflammation-associated gut microbiomes [@tran2019flagellin], flagellin is the immunodominant antigen in CD [@lodes2004bacterial]. 
Further, species in Clostridium cluster XIVa, to which *C. bolteae* is a member, produce these flagellins in CD [@duck2007isolation]. 
These results suggest that *C. bolteae* flagellin may play a criticial role in inflammatory maintenance in CD.
A recent study showed successful reduction of gut flagellin in a mouse model of colitis through immunization with purified flagellin, thereby reducing inflammation, reducing encroachment on host epithelial cells, and reshaping gut microbiota composition [@tran2019flagellin]. 
This, combined with results our survey, suggests that flagellin purified from *C. bolteae* and *Flovonifractor* may be useful in the treatment of CD and UC, respectively.

Genes that are more abundant in *C. bolteae* and *F. gnavus* are enriched for vancomycin resistance, suggesting that patients with CD are more likely to harbor vancomycin resistant organisms.
While vancomycin resistance is enriched among annotated KEGG orthologs, we further idenfied resistant genes using hidden markov models. 
In both *C. bolteae* and *F. gnavus*, we identify genes encoding the two-component regulatory sequence *vanR* and *vanSB*, as well as *vanB*, *vanX*, and *vanW* in *C. bolteae* and *vanY*, *vanH*, and *vanT* in *F. ganvus*. 
Given that CD patients are at an increased risk of hospitalization due to infectious complications of disease, this trend should be further investigated as it may direct empiric antibiotic choices by providers.
IBD patients are at an increased risk for vancomycin-resistant *Enterococcus* infection [@nguyen2011increased].

Concomitant with profound reduction in oxygen-sensitive species, we observe increased abundance of orthologs involved in oxidative stress response in enriched strains. 
In both *C. bolteae* and *F. gnavus*, the pentose phosphate pathway and cysteine and methionine metabolism are enriched.
The oxidative branch of the pentose phosphate pathway regenerates NADPH, while cysteine is a precursor for the antioxidant glutathione.
Many orthologs that quench reactive oxygen (**Table \ref{tab:oxstress}**) and nitrogen species (**Table \ref{tab:nitrostress}**) are also more abundant in these strains and in the *Flavonifractor* strains.

We investigated whether the gene cluster involved in biosynthesis of the inflammatory polysaccharide was significantly more abundant in CD [@henke2019ruminococcus]. 
We identified 19 of 23 ORFs in the *F. gnavus* pangenome that matched the putative genes in the cluster, all of which were more abundant in CD. 
Further, two subsets, one containing five ORFs and one contain seven ORFs, were co-located on two contiguous sequences, indicating these genes do form a biosynthetic cluster.
These results suggest that our k-mer analysis detected the same inflammatory clade of *F. gnavus* as has been previously detected [@hall2017; @henke2019ruminococcus].

## Enriched strains are more abundant in but not exclusive to IBD

While four strains are enriched in IBD, we find no evidence of a disease-specific pangenome within these strains.
Almost all genes in each pangenome are observed in CD, UC, and nonIBD. 
This suggests that the disease environment drives strain enrichment, and that potential negative effects of these strains may be mitigated by the presence of beneficial organisms.

Only *C. bolteae* does not saturate for UC, with 171 of 16,822 genes unobserved.

While we find no evidence of a general disease-specific pangenome, we tested whether the biosynthetic cluster for the inflammatory polysaccharide produced by *F. gnavus* occurs in nonIBD. 
An average of more than 100 reads mapped per gene in the cluster in 10 of 213 nonIBD metagenomes.
While more abundant in CD, this cluster is also identifiable within healthy human gut microbiomes, further supporting the lack of disease-specific pangenomes. 

# Discussion

IBD is a heterogeneous disease characterized by periods of activity and remission. 
While the underlying etiology is poorly understood, IBD arises from a complex interaction between host genetics, environment, and the gut microbiome. 
Here we present a new method to examine microbial associations of disease, and using this method, uncover signatures of IBD subtype. 
These signatures demonstrate consistent loss of diversity of specific microorganisms, particularly in CD. 
Meanwhile, four strains are enriched in CD and two in UC, potentially indicating niche partitioning in response to IBD-associated perturbations. 
The conserved signatures we detect warrant further research and may yield new therapeutics for IBD treatment.

While we find conserved signatures in IBD subtype, we find no evidence for disease-specific microbiomes, or pangenomes of the organisms that comprise them. 
The observation that almost all genes within a pangenome occur in CD, UC, and nonIBD suggests the presence of ecotypes -- subspecies that are adapted to different environments -- rather than pathotypes -- subspecies associated with a specific disease.
Similarly, while a few strains are enriched in IBD microbiomes, these strains are all detected in nonIBD at low frequency. 
These patterns in part explain the inconsistent results generated in IBD subtype characterization, where no consistent microbiological signal has emerged in human gut microbiomes other than loss of diversity (CITATIONS). 
However, the results presented herein demonstrate the need for reference-free analysis of metagenomes. 
Strain-level resolution was essential for the detection of enriched organisms, but this resolution is precluded by reference-based methods. 
Recent large-scale assembly efforts have dramatically improved our catalog of diversity for human microbiomes [@pasolli2019; @nayfach2019; @almeida2019], however many sequences that are signatures of IBD are not in these databases. 
K-mer-based analysis combined with assembly graph queries provides a necessary window into strain-level dynamics in metagenomes. 

Our models consistently performed the most poorly on the iHMP cohort. 
The iHMP tracked the emergence and diagnosis of IBD through time series profiling of emergent cases [@lloyd2019]. 
We selected the first sample in each time series for this analysis. 
Given that our model performed poorly on these samples, this may suggest that disease onset is a distinct biological process. 
One avenue of future research is analysis of these time series samples for emergence of disease signatures. 

While k-mer-based analysis revealed signatures of IBD subtype, 9.1% of shared k-mers were uncharacterized by reference databases or assembly graph queries. 
These k-mers may represent strain variants of the microbial core we detected, or may be novel sequences from other organisms, plasmids, or viruses. 
Targeted graph-based queries may reveal the identity of these elements and their relationship to IBD. 

While we apply our pipeline to IBD classification, it is extensible to other large meta cohorts of metagenomic sequencing data. 
This method may be particularly suitable for disease such as colorectal cancer, where a recent meta-analysis using a marker gene approach was successful in classifying colorectal samples from healthy controls [@wirbel2019].
Our method may bring strain-level resolution and generate hypothesis for further research.

Taken together, XXXXX. 

# Methods

All code associated with our analyses is available at www.github.com/dib-lab/2020-ibd/.

## IBD metagenome data acquisition and processing

We searched the NCBI Sequence Read Archive and BioProject databases for shotgun metagenome studies that sequenced fecal samples from humans with Crohn's disease, ulcerative colitis, and healthy controls. 
We included studies sequenced on Illumina platforms with paired-end chemistries and with sample libraries that contained greater than one million reads. 
For time series intervention cohorts, we selected the first time point to ensure all metagenomes came from treatment-naive subjects. 

We downloaded metagenomic fastq files from the European Nucleotide Archive using the "fastq_ftp" link and concatenated fastq files annotated as the same library into single files. 
We also downloaded iHMP samples from idbmdb.org.
We used Trimmomatic (version 0.39) to adapter trim reads using all default Trimmomatic paired-end adapter sequences (`ILLUMINACLIP:{inputs/adapters.fa}:2:0:15`) and lightly quality-trimmed the reads (`MINLEN:31 LEADING:2 TRAILING:2 SLIDINGWINDOW:4:2`) [@bolger2014]. 
We then removed human DNA using BBMap and a masked version of hg19 [@bushnell2014]. 
Next, we trimmed low-abundance k-mers from sequences with high coverage using khmer's `trim-low-abund.py` [@crusoe2015].  

Using these trimmed reads, we generated scaled MinHash signatures for each library using sourmash (k-size 31, scaled 2000, abundance tracking on) [@brown2016]. 
Scaled MinHash sketching produces compressed representations of k-mers in a metagenome while retaining the sequence diversity in a sample [@pierce2019].
This approach creates a consistent set of k-mers across samples by retaining the same k-mers when the same k-mers are observed. 
This enables comparisons between metagenomes.
We refer to scaled MinHash sketches as *signatures*, and to each sub-sampled k-mer in a signature as a *k-mer*. 
At a scaled value of 2000, an average of one k-mer will be detected in each 2000 base pair window, and 99.8% of 10,000 base pair windows will have at least one k-mer representative. 
We selected a k-mer size of 31 because of its species-level specificity [@koslicki2016].
We retained all k-mers that were present in multiple samples. 

## Principle Coordinates Analysis

We used jaccard distance and cosine distance implemented in `sourmash compare` to pairwise compare scaled MinHash signatures. 
We then used the `dist()` function in base R to compute distance matrices. 
We used the `cmdscale()` function to perform principle coordinate analysis [@gower1966]. 
We used ggplot2 and ggMarginal to visualize the principle coordinate analysis [@wickham2019]. 
To test for sources of variation in these distance matrices, we performed PERMANOVA using the `adonis` function in the R vegan package [@oksanen2010].
The PERMANOVA was modeled as `~ diagnosis + study accession + library size + number of k-mers`.

## Random forest classifiers

We built random forests classifier to predict CD, UC, and non-IBD status using scaled MinHash signatures (k-mer models), marker genes in the shared 41 genomes (marker gene models), signatures from reads that were detected as marker genes (k-mer models of marker genes), and marker genes in the full metagenome (full marker gene models).
 
For models from signatures, we transformed sourmash signatures into a k-mer abundance table where each metagenome was a sample, each k-mer was a feature, and abundances were recorded for each k-mer for each sample. 
We normalized abundances by dividing by the total number of k-mers in each scaled MinHah signature. 
We then used a leave-one-study-out validation approach where we trained six models, each of which was trained on five studies and validated on the sixth. 
To build each model, we first performed vita variable selection on the training set as implemented in the Pomona and ranger packages [@degenhardt2017; @wright2015]. 
Vita variable selection reduces the number of variables (e.g. k-mers) to a smaller set of predictive variables through selection of variables with high cross-validated permutation variable importance [@janitza2018].
It is based on permutation of variable importance, where p-values for variable importance are calculated against a null distribution that is built from variables that are estimated as non-important [@janitza2018].
This approach retains important variables that are correlated [@janitza2018; @seifert2019], which is desirable in omics-settings where correlated features are often involved in a coordinated biological response, e.g. part of the same operon, pathways, or genome [@stuart2003gene; @sabatti2002co]. 
Using this smaller set of k-mers, we then built an optimized random forest model using tuneRanger [@probst2019]. 
We evaluated each validation set using the optimal model, and extracted variable importance measures for each k-mer for subsequent analysis. 
To make variable importance measures comparable across models, we normalized importance to 1 by dividing variable importance by the total number of k-mers in a model and the total number of models.  

For the marker gene models, we generated marker gene abundances for 14 ribosomal marker genes and 16S rRNA using singleM [@woodcroft2018singlem].
We then followed the same model building procedure as the k-mer models. 
 
## Anchoring predictive k-mers to genomes

We used sourmash `gather` with parameters `k 31` and `--scaled 2000` to anchor predictive k-mers to known genomes [@brown2016]. 
Sourmash `gather` searches a database of known k-mers for matches with a query [@pierce2019].
We used the sourmash GenBank database (2018.03.29, https://osf.io/snphy/), and built three additional databases from medium- and high-quality metagenome-assembled genomes from three human microbiome metagenome reanalysis efforts (https://osf.io/hza89/) [@pasolli2019; @nayfach2019; @almeida2019].
In total, approximately 420,000 microbial genomes and metagenome-assembled genomes were represented by these four databases. 
We used the sourmash `lca` commands against the GTDB taxonomy database to taxonomically classify the genomes that contained predictive k-mers.
To calculate the cumulative variable importance attributable to a single genome, we used an iterative winner-takes-all approach.
The genome with the largest fraction of predictive k-mers won the variable importance for all k-mers contained within its genome.
These k-mers were then removed, and we repeated the process for the genome with the next largest fraction of predictive k-mers. 

To identify k-mers that were predictive in at least five of six models, we took the union of predictive k-mers from all combinations of five models, as well as from the union of all six models.
We refer to these k-mers as shared predictive k-mers.
We anchored variable importance of these shared predictive k-mers to known genomes using sourmash `gather` as above. 

## Compact de Bruijn graph queries for predictive genes and genomes

To annotate k-mers with functional potential, we first extracted open reading frames (ORFs) from the shared 41 genomes using prokka, and annotated ORFs with EggNog [@seemann2014prokka; @huerta2019eggnog].
When then used spacegraphcats `multifasta_query` to create a k-mer:gene map.
Spacegraphcats retrieves k-mers in the compact de Bruijn graph neighborhood of a query gene, and hashing these k-mers via sourmash generates a hash:gene map [@brown2020exploring; @brown2016]. 
Because genomes with shared 31-mers may annotate the same hash, we allowed k-mers to be annotated multiple times. 
This was particularly appropriate for k-mers from highly conserved regions, e.g. 16S ribosomal RNA.

We used spacegraphcats `search` to retrieve k-mers in the compact de Bruijn graph neighborhood of the shared genomes [@brown2020exploring]. 
We then used spacegraphcats `extract_reads` to retrieve the reads and `extract_contigs` to retrieve unitigs in the compact de Bruijn graph that contained those k-mers, respectively.
These reads were used to generate marker gene abundances for the 41 shared genomes for the marker gene random forest models.
 
## Differential k-mer abundance analysis

To determine whether shared k-mers were differentially abundant from nonIBD in UC or CD, we used corncob [@martin2020modeling].
We used all k-mer abundances from sourmash signatures to determine k-mer library size, and then compared k-mer abundances between disease groups using the likelihood ratio test with the formula `study_accession + diagnosis` and the null formula `study_accession` [@martin2020modeling]. 
We considered genes with p values < .05 after bonferonni correction as statistically significant. 
We performed enrichment analysis using the R package clusterProfiler [@yu2012clusterprofiler]. 

## Pangenome analysis

**Pangenome signatures** To evaluate the k-mers recovered by pangenome neighborhood queries, we generated sourmash signatures from the unitigs in each query neighborhood. 
We merged signatures from the same query genome, producing 41 pangenome signatures. 
We indexed these signatures to create a sourmash gather database. 
To estimate how query neighborhoods increased the identifiable fraction of predictive k-mers, we ran sourmash `gather` with the pangenome database, as well as the GenBank and human microbiome metagenome databases. 
To estimate how query neighborhoods increased the identifiable fraction of shared predictive k-mers, we ran sourmash `gather` with the pangenome database alone.
We anchored variable importance of the shared predictive k-mers to known genomes using sourmash `gather` results as above. 

**Pangenome assembly** We used diginorm on each spacegraphcats query neighborhood implemented in khmer as `normalize-by-median.py` with parameters `-k 20 -C 20` [@crusoe2015]. 
We then assembled each neighborhood from a single query with `megahit` using default parameters [@li2015megahit], and annotated each assembly using prokka [@seemann2014prokka].
We used CD-HIT to cluster nucleotide sequences within a pangenome at 90% identity and retained the representative sequence [@fu2012cd].
We annotated representative sequences with EggNog [@huerta2019eggnog].
We used Salmon to quantify the number of reads aligned to each representative gene sequence [@patro2017salmon], and BWA to quantify the number of mapped and unmapped reads [@li2013aligning].

To identify potential genes encoding vancomycin resistance, we performed hidden markov model searches against the pangenome. 
We used the `hmmscan` command from HMMER against the Resfam database with a threshold of 200 [@hmmer; @gibson2015improved].

# References

<div id="refs"></div>

\newpage
# Supplementary material {-}

\beginsupplement

```{r confusionplts, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE, cache=TRUE, fig.width=4, fig.cap="Confusion matrices for leave-one-study-out random forest models evaluated on the validation set. **A** k-mer model. **B** marker gene model. **C** k-mer model of marker genes.", out.width="400px"}
knitr::include_graphics('figures/figS2.pdf')
```

```{r upset, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE, cache=TRUE, fig.width=4, fig.cap="K-mer models share a large fraction of predictive k-mers. Upset plot depicting intersections of sets of k-mers as well as the cumulative normalized variable importance of those k-mers in the optimized random forest classifiers. Each classifier is labelled by the left-out validation study.", out.width="400px"}
knitr::include_graphics('figures/figS3.pdf')
```

```{r pipeline, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE, cache=TRUE, fig.width=4, fig.cap="Simplified directed acyclic graph of the steps used in our pipeline, color coded by the section of the pipeline each step corresponds to. The steps in blue were performed six times, each time with a different validation study.", out.width="400px"}
knitr::include_graphics('figures/figS1.pdf')
```

```{r varselhashes, echo=FALSE, message=FALSE, warnings=FALSE}
varsel_data <- "
Validation study|Selected k-mers |Percent of total k-mers
PRJNA385949 | 41701 | 0.57% 
PRJNA237362 | 40726 | 0.55% 
iHMP        | 39628 | 0.54% 
PRJEB2054   | 35343 | 0.48% 
PRJNA400072 | 32578 | 0.44% 
SRP057027   | 29264 | 0.40% "      
df <- read.delim(textConnection(varsel_data), header=T,sep="|", strip.white=TRUE, stringsAsFactors=FALSE)
row.names(df)<-NULL
kable(df, format = "latex", booktabs = T, 
      caption = "Number of predictive k-mers after variable selection for each of 6 classifiers. Classifiers are labelled by the validation study that was held out from training.",
      col.names = c("Validation study", "Selected k-mers", "Percent of total k-mers")) %>%
  kable_styling(font_size = 9, latex_options ="striped")
```


```{r oxstress, echo=FALSE, message=FALSE, warnings=FALSE}
ox_data <- "species|KEGG_ko|definition
Faecalicatena gnavus|K00362|nirB; nitrite reductase (NADH) large subunit [EC:1.7.1.15]
Faecalicatena gnavus|K11717|sufS; cysteine desulfurase / selenocysteine lyase [EC:2.8.1.7 4.4.1.16]
Faecalicatena gnavus|K01926|rex; redox-sensing transcriptional repressor
Faecalicatena gnavus|K01069|gloB, gloC, HAGH; hydroxyacylglutathione hydrolase [EC:3.1.2.6]
Faecalicatena gnavus|K03671|trxA; thioredoxin 1
Faecalicatena gnavus|K04565|SOD1; superoxide dismutase, Cu-Zn family [EC:1.15.1.1]
Faecalicatena gnavus|K14155|patB, malY; cysteine-S-conjugate beta-lyase [EC:4.4.1.13]
Clostridium_M bolteae|K11717|sufS; cysteine desulfurase / selenocysteine lyase [EC:2.8.1.7 4.4.1.16]
Clostridium_M bolteae|K01069|gloB, gloC, HAGH; hydroxyacylglutathione hydrolase [EC:3.1.2.6]
Clostridium_M bolteae|K14155|patB, malY; cysteine-S-conjugate beta-lyase [EC:4.4.1.13]
Clostridium_M bolteae|K03386|PRDX2_4, ahpC; peroxiredoxin 2/4 [EC:1.11.1.24]
Clostridium_M bolteae|K01758|CTH; cystathionine gamma-lyase [EC:4.4.1.1]
Clostridium_M bolteae|K03564|BCP, PRXQ, DOT5; thioredoxin-dependent peroxiredoxin [EC:1.11.1.24]
Clostridium_M bolteae|K00362|nirB; nitrite reductase (NADH) large subunit [EC:1.7.1.15]
Clostridium_M bolteae|K01926|rex; redox-sensing transcriptional repressor
Clostridium_M bolteae|K04565|SOD1; superoxide dismutase, Cu-Zn family [EC:1.15.1.1]
Clostridium_M bolteae|K03676|grxC, GLRX, GLRX2; glutaredoxin 3
Flavonifractor sp000508885|K01759|GLO1, gloA; lactoylglutathione lyase [EC:4.4.1.5]
Flavonifractor sp000508885|K03671|trxA; thioredoxin 1
Flavonifractor sp000508885|K01758|CTH; cystathionine gamma-lyase [EC:4.4.1.1]
Flavonifractor plautii|K01759|GLO1, gloA; lactoylglutathione lyase [EC:4.4.1.5]
Flavonifractor plautii|K01758|CTH; cystathionine gamma-lyase [EC:4.4.1.1]
Flavonifractor plautii|K14155|patB, malY; cysteine-S-conjugate beta-lyase [EC:4.4.1.13]"      
df <- read.delim(textConnection(ox_data), header=T,sep="|", strip.white=TRUE, stringsAsFactors=FALSE)
row.names(df)<-NULL
kable(df, format = "latex", booktabs = T, 
      caption = "KEGG orthologs involved in oxidative stress response annotated in strains that are more abundant in IBD. KEGG orthologs are only displayed if they were only annotated amoung the more abundant genes, not annotated amoung both the more abundant and less abundant genes in a species.") %>%
  kable_styling(font_size = 9, latex_options ="striped")
```

```{r nitrostress, echo=FALSE, message=FALSE, warnings=FALSE}
nitro_data <- "species|KEGG_ko|definition
Faecalicatena gnavus|K00362|nirB; nitrite reductase (NADH) large subunit [EC:1.7.1.15]
Faecalicatena gnavus|K05601|hcp; hydroxylamine reductase [EC:1.7.99.1]
Clostridium_M bolteae|K03386|PRDX2_4, ahpC; peroxiredoxin 2/4 [EC:1.11.1.24]
Clostridium_M bolteae|K00362|nirB; nitrite reductase (NADH) large subunit [EC:1.7.1.15]
Clostridium_M bolteae|K05601|hcp; hydroxylamine reductase [EC:1.7.99.1]"      
df <- read.delim(textConnection(nitro_data), header=T, sep="|", strip.white=TRUE, stringsAsFactors=FALSE)
row.names(df)<-NULL
kable(df, format = "latex", booktabs = T, 
      caption = "KEGG orthologs involved in oxidative stress response caused by reactive nitrogen species and annotated in strains that are more abundant in IBD. KEGG orthologs are only displayed if they were only annotated amoung the more abundant genes, not annotated amoung both the more abundant and less abundant genes in a species.") %>%
  kable_styling(font_size = 9, latex_options ="striped")
```

## Description of IBD metagenome study cohorts

Below we present a description of each of the six cohorts used in this meta analysis.
Each description is presented as was found in the original publication of each cohort.


**iHMP** [@lloyd2019]: 

> Five medical centres participated in the IBDMDB: Cincinnati Children’s Hospital, Emory University Hospital, Massachusetts General Hospital, Massachusetts General Hospital for Children, and Cedars-Sinai Medical Center. 
> Patients were approached for potential recruitment upon presentation for routine age-related colorectal cancer screening, work up of other gastrointestinal (GI) symptoms, or suspected IBD, either with positive imaging (for example, colonic wall thickening or ileal inflammation) or symptoms of chronic diarrhoea or rectal bleeding. 
> Participants could not have had a prior screening or diagnostic colonoscopy. 
> Potential participants were excluded if they were unable to or did not consent to provide tissue, blood, or stool, were pregnant, had a known bleeding disorder or an acute gastrointestinal infection, were actively being treated for a malignancy with chemotherapy, were diagnosed with indeterminate colitis, or had undergone a prior, major gastrointestinal surgery such as an ileal/colonic diversion or j-pouch. 
> Upon enrollment, an initial colonoscopy was performed to determine study strata. 
> Subjects not diagnosed with IBD based on endoscopic and histopathologic findings were classified as ‘non-IBD’ controls, including the aforementioned healthy individuals presenting for routine screening, and those with more benign or non-specific symptoms. 
> This creates a control group that, while not completely ‘healthy’, differs from the IBD cohorts specifically by clinical IBD status. 
> Differences observed between these groups are therefore more likely to constitute differences specific to IBD, and not differences attributable to general GI distress. 

**PRJEB2054** [@qin2010]: 

> As part of the MetaHIT (Metagenomics of the Human Intestinal Tract) project, we collected faecal specimens from 124 healthy, overweight and obese individual human adults, as well as inflammatory bowel disease (IBD) patients, from Denmark and Spain.

**SRP057027** [@lewis2015]:
 
> Children and young adults less than 22 years of age were enrolled at the time of initiation of EN or anti-TNF therapy for treatment of active CD (defined as the Pediatric Crohn's Disease Activity Index [PCDAI] >10) at The Hospital for Sick Children in Toronto, ON, Canada; IWK Health Centre, Halifax, NS, Canada; and the Children's Hospital of Philadelphia, Pennsylvania. 
> Participants in this observational cohort study were prescreened for eligibility and recruited from clinic or during inpatient hospitalization. Exclusion criteria included presence of an ostomy, treatment with probiotics within 2 weeks of initiating EN, treatment with anti-TNF therapy within 8 weeks of starting EN, or treatment with EN within 1 week of initiating anti-TNF therapy. 
> The study protocol was approved by the institutional review boards at all participating institutions. 
> Informed consent was obtained from all young adults and the parents/guardians of children less than 18 years of age.

**PRJNA385949** [@hall2017]: 

> Samples from the PRISM study, collected at Massachusetts General Hospital: A subset of the PRISM cohort was selected for longitudinal analysis. 
> A total of 15 IBD cases (nine CD, five UC, one indeterminate colitis) were enrolled in the longitudinal stool study (LSS). 
> Three participants with gastrointestinal symptoms that tested negative for IBD were included as a control population. 
> Enrollment in the study did not affect treatment. 
> Stool samples were collected monthly, for up to 12 months. 
> The first stool sample was taken after treatment had begun. 
> Comprehensive clinical data for each of the participants was collected at each visit. 
> At each collection, a subset of participants were interviewed to determine their disease activity index, the Harvey-Bradshaw index for CD participants and the simple clinical colitis activity index (SCCAI) for UC participants.
> Samples collected at Emory University: To increase the number of participants in our analysis, a subset of the pediatric cohort STiNKi was selected for whole metagenome sequencing including five individuals with UC and nine healthy controls.
> All selected UC cases were categorized as non-responders to treatment.
> Stool samples were collected approximately monthly for up to 10 months. 
> The first sample from participants in the STiNKi cohort is before treatment started, and subsequent samples are after treatment started. 
> Stool collection and DNA extraction methods are detailed in Shaw et al.

**PRJNA400072**  [@franzosa2019]:

> PRISM cohort description and sample handling: PRISM is a referral centre-based, prospective cohort of IBD patients; 161 adult patients (>18 years old) enrolled in PRISM and diagnosed with CD, UC, and non-IBD (control) were selected for this study, with diagnoses based on standard endoscopic, radographical and histological criteria. 
> The PRISM research protocols were reviewed and approved by the Partners Human Research Committee (re. 2004-P-001067), and all experiments adhered to the regulations of this review board. 
> PRISM patient stool samples were collected at the MGH gastroenterolgy clinic and stored at -80C before DNA was extracted. 
> 
> Validation cohort description and sample handling: The validation cohort consisted of 65 patients enrolled in two distinct studies form the Netherlands; 22 controls were enrolled in the LifeLines DEEP general population study and 43 patients with IBD were enrolled in a study at the Department of Gastroenterology and Hematology at the University Medical Center Groningen. 
> Patients enrolled in both studies collected stool using the same protocol: a single stool sample was collected at home and then frozen within 15 min in a conventional freezer. 
> A research nurse visited all participants at home to collect home-frozen stool samples, which were then transported and stored at -80C. 
> The stool samples were kept frozen before DNA was extracted.

**PRJNA237362** [@gevers2014]: 

> A total of 447 children and adolescents (<17 years) with newly diagnosed CD and a control population composed of 221 subjects with noninflammatory conditions of the gastrointestinal tract were enrolled to the RISK study in 28 participating pediatric gastroenterology centers in North America between November 2008 and January 2012.
 

## Construction of human microbiome metagenome assembled genome databases

While GenBank contains hundreds of thousands of isolate and metagenome-assembled genomes, we augmented the number of genomes by creating sourmash databases for all medium- and high-quality metagenome-assembled genomes from three recent human microbiome metagenome *de novo* assembly efforts [@pasolli2019; @nayfach2019; @almeida2019]. 
The databases are available at in the OSF repository, "Comprehensive Human Microbiome Sourmash Databases" at the URL https://osf.io/hza89/.
While we are aware that contamination in both GenBank and from these studies could introduce contamination into our analysis, we reasoned that the increase we observed in identifiable k-mers when we did not restrict ourselves to RefSeq was worth the trade.  

To generate the databases, we downloaded the medium- and high-quality metagenome-assembled genomes and used sourmash `compute` with parameters `k 21,31,51`, `--track-abundance`, and `--scaled 2000`. 
We then used sourmash `index` to generate databases for `k = 31`.
Below we detail the contents of each database. 

+ @pasolli2019: contains 70,178 high- and 84,545 medium-quality MAGs assembled from 9,428 human microbiome samples. Samples originate from stool (7,783), oral cavity (783), skin (503), vagina (88), and maternal milk (9). Original Data Download: http://segatalab.cibio.unitn.it/data/Pasolli_et_al.html
+ @almeida2019: contains 40,029 high- and 65,671 medium-quality MAGs assembled from 11,850 human microbiome samples. All samples originate from stool. Original Data Download: ftp://ftp.ebi.ac.uk/pub/databases/metagenomics/umgs_analyses/mags-gut_qs50.tar.gz
+ @nayfach2019: contains 24,345 high- and 36,319 medium-quality MAGs assembled from 3,810 human gut microbiome samples. Original Data Download: https://github.com/snayfach/IGGdb


## 41 genome accessions and taxonomy


```{r genomes, echo=FALSE, message=FALSE, warnings=FALSE}
genomes_data <- "
 genome                                           | GTDB                                 | NCBI                              
 ERS235530_10.fna                                 | s__CAG-1024 sp000432015              | Clostridium sp. CAG:1024
 ERS235531_43.fna                                 | s__Faecalibacterium prausnitzii_F    | NA
 ERS235603_16.fna                                 | s__Agathobacter rectale              | [Eubacterium] rectale
 ERS396297_11.fna                                 | s__Lachnospira eligens_B             | [Eubacterium] eligens 
 ERS396519_11.fna                                 | s__Lawsonibacter asaccharolyticus    | Clostridium phoceensis 
 ERS473255_26.fna                                 | s__Faecalibacterium prausnitzii_G    | NA
 ERS537218_9.fna                                  | s__Gemmiger sp003476825              | Faecalibacterium sp. UBA2087 
 ERS537235_19.fna                                 | s__Bacteroides_B massiliensis        | NA 
 ERS537328_30.fna                                 | s__Faecalibacterium prausnitzii_K    | NA   
 ERS537353_12.fna                                 | g__Flavonifractor                    | NA 
 ERS608524_37.fna                                 | s__Gemmiger formicilis               | NA 
 ERS608576_22.fna                                 | s__Ruminococcus_E bromii_B           | NA 
 GCF_000371685.1_Clos_bolt_90B3_V1_genomic.fna    | s__Clostridium_M bolteae             | Clostridium bolteae 90B3
 GCF_000508885.1_ASM50888v1_genomic.fna           | s__Flavonifractor sp000508885        | Clostridiales bacterium VE202-03
 GCF_001405615.1_13414_6_47_genomic.fna           | s__Agathobacter faecis               | Roseburia faecis strain 2789STDY5608863
 GCF_900036035.1_RGNV35913_genomic.fna            | s__Faecalicatena gnavus              | [Ruminococcus] gnavus
 LeChatelierE_2013__MH0074__bin.19.fa             | s__CAG-45 sp900066395                | NA
 LiJ_2014__O2.UC28-1__bin.61.fa                   | s__Ruminiclostridium_E siraeum       | [Eubacterium] siraeum 
 LiSS_2016__FAT_DON_8-22-0-0__bin.28.fa           | s__CAG-170 sp000432135               | Firmicutes bacterium CAG:124
LoombaR_2017__SID1050_bax__bin.11.fa             | s__Anaeromassilibacillus sp002159845 | Anaeromassilibacillus sp. An250 
NielsenHB_2014__MH0094__bin.44.fa                | s__Prevotella copri                  | NA  
QinJ_2012__CON-091__bin.20.fa                    | s__Faecalibacterium prausnitzii_G    | NA
SRR4305229_bin.5.fa                              | s__Roseburia inulinivorans           | NA 
SRR5127401_bin.3.fa                              | s__UBA11774 sp003507655              | NA 
SRR5558047_bin.10.fa                             | s__Alistipes putredinis              | NA 
SRR6028281_bin.3.fa                              | s__Lachnospira eligens_B             | [Eubacterium] eligens
SRS075078_49.fna                                 | s__TF01-11 sp003529475               | Clostridium sp. CAG:75; Clostridium sp. 42_12           
SRS103987_37.fna                                 | s__ER4 sp000765235                   | Oscillibacter sp. ER4
SRS104400_110.fna                                | s__Lachnospira sp900316325           | NA         
SRS143598_15.fna                                 | s__Lachnospira sp000437735           | NA
SRS1719112_8.fna                                 | s__Oscillibacter sp900066435         | NA  
SRS1719498_9.fna                                 | s__Acetatifactor sp900066565         | Clostridium 
SRS1719577_6.fna                                 | s__Faecalibacterium prausnitzii_D    | NA 
SRS1735506_4.fna                                 | s__Bacteroides ovatus                | NA 
SRS1735645_19.fna                                | s__Acetatifactor sp900066365         | Firmicutes bacterium CAG:65; clostridium
SRS294916_20.fna                                 | s__Romboutsia timonensis             | NA     
SRS476209_42.fna                                 | s__Ruminococcus_D bicirculans        | NA 
VatanenT_2016__G80445__bin.9.fa                  | s__Faecalibacterium prausnitzii_D    | NA
VogtmannE_2016__MMRS43563715ST-27-0-0__bin.70.fa | s__CAG-81 sp900066785                | uncultured Clostridium sp.
XieH_2016__YSZC12003_37172__bin.63.fa            | s__Acutalibacter sp000435395         | Firmicutes bacterium CAG:94 
ZeeviD_2015__PNP_Main_232__bin.27.fa             | s__Blautia_A sp900066165             | uncultured Blautia sp.; Ruminococcus sp. Marseille-P328"      
df <- read.delim(textConnection(genomes_data), header=T,sep="|", strip.white=TRUE, stringsAsFactors=FALSE)
row.names(df)<-NULL
kable(df, format = "latex", booktabs = T, 
      caption = "Identifiers, GTDB and NCBI taxonomy for the 41 shared genomes.") %>%
  kable_styling(font_size = 8, latex_options ="striped")
```

Genomes are available for download at https://osf.io/ungza/

## Contamination in 41 shared genomes

We identified 41 genomes that were important for IBD subtype classification across six models.
We used assigned GTDB taxonomy to each genome.
38 species represented among the 41 genomes. 
However, we observe that while most genomes assign to one species, 19 assign to an additional one or more distantly related genomes that likely represent contamination from the assembly and binning process. 
When we take the Jaccard index of these 41 genomes, we observe little similarity despite contamination (**Figure \ref{fig:compgenomes}**).
Therefore, we proceeded with analysis with the idea that each of the 41 genomes is a self-contained entity that captures distinct biology.

```{r compgenomes, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE, cache=TRUE, fig.cap="Jaccard similarity between 41 genomes. The highest similarity between genomes is 0.37 and is shared by genomes of the same species, while most genomes have no similarity. This indicates that each genome represents distinct nucleotide sequence."}
knitr::include_graphics("figures/figS4.pdf")
```

## Characterization of unknown but predictive k-mers through assembly graph queries 

Given that 30.6% of shared k-mers did not anchor to genomes in databases, we sought to characterize these k-mers. 
We reasoned that many unknown but predictive k-mers likely originate from closely related strain variants of identified genomes, or from closely-related sequences not assembled or binned during the original genome analysis.
We sought to recover these variants. 
We performed assembly graph queries into each metagenome sample with the 41 genomes that contained shared k-mers, producing a pangenome for each query genome within each metagenome sample.
Combining pangenomes from all metagenomes, we generated a metapangenome for each of the 41 original query genomes.
90.9% of shared k-mers were in the 41 metapangenomes, a 21.5% increase over the genomes alone. 
This suggests that at least 21.5% of shared k-mers originate from strain-variable or accessory elements in pangenomes. 

Further, these metapangenomes captured an additional 4.2-5.2% of all predictive k-mers from each classifier, indicating that metapangenomes contain novel sequences not captured in any database (**Figure \ref{fig:sgcplt}**).
The metapangenomes also captured 74.5% of all variable importance, a 24% increase over the 41 genomes alone. 
This indicates that uncharacterizable sequences contribute substantial predictive power toward IBD subtype classification.

Recovery of metapangenomic variation disproportionately impacts the variable importance attributable to specific genomes (**Figure \ref{fig:sgcplt}**).
While most genomes maintained a similar proportion of importance with or without expansion by neighborhood queries, three metapangenomes shifted dramatically.
While an *Acetatifactor* species anchored the most importance prior to pangenome queries, the specific species of *Acetatifactor* switched from *sp900066565*, to *sp900066365*. 
Conversely, *Faecalibacterium prausnitzii_D* increased from anchoring ~2.9% to ~10.5% of the total variable importance. 
This is likely in part driven by re-association of marker genes with genomes given that marker genes are difficult to assemble and bin in metagenomes.
Strain-variable regions are also likely recovered [@brown2020exploring].

```{r sgcplt, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE,fig.cap="**A** Some k-mers anchor to known genomes in RefSeq, GenBank, or human microbiome metagenome-assembled genome databases. An additional approximately 5% of k-mers anchor to metapangenome of the 41 shared genomes. **B** Metapangenome neighborhoods generated with assembly graph queries recover strain variation that is important for predicting IBD subtype. While the variable importance attributable to some genomes does not change with assembly graph queries, other genomes increase by more than 7%."}
knitr::include_graphics("figures/figS5.pdf")
```

## Comparing IBD metagenome analysis by assembly 

While gene-based queries successfully annotated our shared k-mers, we were curious how well an assembly-based approach could characterize pangenome graph neighborhoods.
To build a gene catalog for each metapangenome, we assembled each pangenome individually and extracted open reading frames (ORFs). 
We then clustered ORFs and ORF fragments from pangenomes in the metapangenome at 90% identity.

While the reads from all metapangenomes contain 90.9% of shared k-mers, the metapangenome gene catalogs only contain 59.4% of shared k-mers. 
While this loss is in part explained by ORF extraction and clustering, only 63.1% of shared k-mers are in the assemblies themselves, demonstrating that assembly accounts for the largest loss of predictive k-mers. 
Further, when we build random forest models of gene counts using the leave-one-study out approach, we observe a substantial decrease in prediction accuracy (**Table \ref{tab:accsupp}**). 
This indicates that some sequences that are important for IBD classification do not assemble.

```{r accsupp, echo=FALSE, message=FALSE, warnings=FALSE}
accs_data <- "
Validation Study | k-mer model | Marker gene model | Gene model 
SRP057027        |    75.9    |      86.4       |   44   
PRJNA237362      |    71.4    |       75        |   NA   
PRJEB2054        |    69.4    |      19.1       |   NA 
PRJNA385949      |    52.9    |      52.9       |   35.3   
PRJNA400072      |    50.9    |      48.1       |   50   
iHMP             |    49.1    |      44.2       |   44.3"      
df <- read.delim(textConnection(accs_data), header=T,sep="|", strip.white=TRUE, stringsAsFactors=FALSE)
row.names(df)<-NULL
kable(df, format = "latex", booktabs = T, 
      caption = "Accuracy of model on each validation set.") %>%
  kable_styling(font_size = 9, latex_options ="striped")
```


Unassembled k-mers occur in 40 of the 41 metapangenomes.
K-mers that are unassembled are not more likely to hold higher variable importance than k-mers that do not assemble (Welch Two Sample t-test p = .07; mean assembled = 0.00057, mean unassembled = 0.00072). 

We next determined which shared k-mers were not captured by assembly.
Using gene neighborhood queries from the 41 shared genomes as described in the main text, many unassembled k-mers were annotated as 16s and 23s ribosomal RNA, as well as genes encoding 30s and 50s ribosomal proteins. 
These sequences are difficult to assemble given their repetitive content, but are useful markers of taxonomy given their universal presence in bacterial genomes [@yuan2015reconstructing; @parks2015checkm; @woodcroft2018singlem]. 

While many k-mers that are predictive of IBD subtype do not assemble, approximately 60% do.
We next investigated how metapangenomes differed in CD, UC, and nonIBD based on these assembled fractions alone.

Given that reduced diversity of species in the gut microbiome is a hallmark of IBD (CITATIONS), we first investigated whether the diversity of metapangenome ORFs within a metagenome differed between CD and nonIBD and UC and nonIBD. 
For each metagenome, we counted the number of ORFs within each metapangenome against which any reads mapped.
For 39 of 41 metapangenomes for CD and 37 of 41 metapangenomes for UC, the mean number of ORFs observed per metagenome was lower than nonIBD (ANOVA p < 0.05, Tukey's HSD p < 0.05). 
This indicates that the majority of metapangenomes in IBD microbiomes have lower diversity in observed ORFs than nonIBD microbiomes.

Only the metapangenome of *Clostridium bolteae* had a higher mean number of observed ORFs per sample in CD than nonIBD. 

In three pangenomes, we see a higher mean number of genes observed per sample for UC than CD or nonIBD. 
These include *R. timonensis*, *Anaeromassilibacillus*, and *Actulibacter*. 

Only *Faecalicatena gnavus* (*Ruminococcus gnavus* in NCBI taxonomy) showed no difference in the mean number of genes per sample between CD and nonIBD and UC and nonIBD. 
*F. gnavus* is an aerotolerant anaerobe, one clade of which has only been found in the guts of IBD patients [@hall2017].
*F. gnavus* produces an inflammatory polysaccharide that induces TNFa secretion in a response mediated by toll-like receptor 4 [@henke2019ruminococcus].

While there is lower diversity of ORFs in IBD metapangenomes, we find limited evidence of disease-specific metapangenomes. 
We generated accumulation curves from ORF presence/absence across CD, UC, and nonIBD using metapangenome gene catalogs.
While our assemblies were incomplete, we reasoned that by investigating the same set of genes for all samples, we could compare across groups. 
For most metapangenomes, the majority of genes are observed in CD, UC, and nonIBD.
This in part explains heterogeneous study findings in IBD gut microbiome investigations (CITATIONS) and underscores that IBD is a spectrum of diseases characterized by intermittent health and dysbiosis.

ADD A GENE ACCUMULATION CURVE PANEL

Of all metapangenome accumulation curves, only *C. bolteae* does not saturate for UC, with 171 of 16,822 genes unobserved.

Ten of 41 do not saturate for CD, with an average of 366 genes unobserved.


```{r assembled, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE,fig.cap="**A** A large fraction of shared k-mers do not assemble. The largest fraction segregates to those that are less abundant in CD than nonIBD. **B** Unassembled shared k-mers are distributed across the 41 shared genomes."}
knitr::include_graphics("figures/figS6.pdf")
```

```{r hashcontentsupp, eval=TRUE, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE,fig.cap="More abundant k-mers in CD are enriched in metabolic pathways and contain few marker genes. Only pathways that are significantly enriched in two of the four genomes are depicted."}
knitr::include_graphics("figures/figS7.pdf")
```


# Supplementary References
